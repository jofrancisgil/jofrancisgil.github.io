<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Comarques - Jo Recursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; }
        
        .quiz-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .quiz-btn:active { transform: scale(0.95); }
        
        /* Animació de barra de temps */
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        .timer-bar.active {
            animation: shrink 10s linear forwards;
        }

        /* Feedback visual */
        .correct-anim { animation: pulseGreen 0.5s; background-color: #22c55e !important; border-color: #15803d !important; color: white; }
        .wrong-anim { animation: shake 0.5s; background-color: #ef4444 !important; border-color: #b91c1c !important; color: white; opacity: 0.5; }
        
        @keyframes pulseGreen {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Vidre i ombres */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 4px solid #f0fdf4; /* green-50 */
        }

        /* Estils per als selectors */
        .config-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            border: 2px solid #dcfce7; /* green-100 */
            background-color: white;
            color: #166534; /* green-800 */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .config-btn:hover { border-color: #16a34a; color: #16a34a; }
        .config-btn.selected {
            background-color: #16a34a; /* green-600 */
            border-color: #16a34a;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.3);
        }
    </style>
</head>
<!-- Fons verd per temàtica Medi -->
<body class="bg-green-600 min-h-screen flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <!-- Navegació superior integrada (Igual que a Gestió) -->
    <nav class="w-full p-4 z-50">
        <div class="max-w-3xl mx-auto flex justify-between items-center text-white">
            <a href="medi.html" class="flex items-center hover:text-green-100 transition font-bold bg-green-700/50 px-4 py-2 rounded-full backdrop-blur-sm">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Tornar a Medi
            </a>
            <div class="flex items-center gap-2 bg-green-700/50 px-4 py-2 rounded-full backdrop-blur-sm">
                <i data-lucide="map" class="w-5 h-5"></i>
                <span class="font-bold hidden sm:inline">Geografia</span>
            </div>
        </div>
    </nav>

    <div class="flex-grow flex items-center justify-center p-4 w-full">
        <div class="w-full max-w-2xl">
            
            <!-- PANTALLA D'INICI -->
            <div id="startScreen" class="glass-panel rounded-3xl p-6 md:p-8 text-center shadow-2xl">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 animate-bounce">
                    <i data-lucide="map-pin" class="w-10 h-10"></i>
                </div>
                <h1 class="text-3xl md:text-5xl font-bold text-slate-800 mb-2">Quiz Comarques</h1>
                <p class="text-slate-500 mb-6">Configura la teva partida</p>
                
                <!-- Configuració -->
                <div class="space-y-6 mb-8 text-left">
                    
                    <!-- Zona Geogràfica (Multi-selecció) -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Zona Geogràfica</label>
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start" id="zoneSelector">
                            <button class="config-btn selected" data-zone="all" onclick="toggleZone('all')">Tota Catalunya</button>
                            <button class="config-btn" data-zone="Barcelona" onclick="toggleZone('Barcelona')">Barcelona</button>
                            <button class="config-btn" data-zone="Girona" onclick="toggleZone('Girona')">Girona</button>
                            <button class="config-btn" data-zone="Lleida" onclick="toggleZone('Lleida')">Lleida</button>
                            <button class="config-btn" data-zone="Tarragona" onclick="toggleZone('Tarragona')">Tarragona</button>
                        </div>
                    </div>

                    <!-- Nombre de Preguntes -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Nombre de Preguntes</label>
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start" id="amountSelector">
                            <button class="config-btn" onclick="selectAmount(this, 10)">10</button>
                            <button class="config-btn" onclick="selectAmount(this, 20)">20</button>
                            <button class="config-btn" onclick="selectAmount(this, 30)">30</button>
                            <button class="config-btn selected" onclick="selectAmount(this, 'all')">TOTES</button>
                        </div>
                        <p id="questionInfo" class="text-xs text-green-500 mt-2 font-medium h-4"></p>
                    </div>

                </div>

                <button onclick="startQuiz()" class="w-full py-4 bg-green-600 hover:bg-green-700 border-b-4 border-green-800 text-white font-bold text-2xl rounded-2xl shadow-lg transition-all active:border-b-0 active:translate-y-1 flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-6 h-6 fill-current"></i> Jugar Ara!
                </button>
            </div>

            <!-- PANTALLA DE JOC -->
            <div id="gameScreen" class="hidden relative">
                
                <!-- Capçalera Joc -->
                <div class="flex justify-between items-center mb-4 text-white font-bold text-lg drop-shadow-md">
                    <div class="flex items-center gap-2">
                        <span class="bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm" id="questionCounter">1 / 43</span>
                        <span class="bg-green-800/50 px-2 py-1 rounded text-xs uppercase" id="zoneBadge">CAT</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full flex items-center gap-1 shadow-sm">
                            <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                            <span id="scoreDisplay">0</span>
                        </span>
                    </div>
                </div>

                <!-- Targeta Pregunta -->
                <div class="bg-white rounded-3xl shadow-2xl overflow-hidden mb-4">
                    <!-- Barra de Temps -->
                    <div class="h-3 bg-slate-100 w-full">
                        <div id="timerBar" class="h-full bg-green-500 origin-left"></div>
                    </div>

                    <div class="p-8 text-center">
                        <span class="uppercase tracking-widest text-xs font-bold text-slate-400 mb-2 block">Quina és la capital de...</span>
                        <h2 id="questionText" class="text-4xl font-bold text-slate-800 mb-2">La Garrotxa</h2>
                        
                        <!-- Ràtua de foc -->
                        <div id="streakBadge" class="hidden inline-flex items-center gap-1 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-sm font-bold mt-2 animate-pulse">
                            <i data-lucide="flame" class="w-4 h-4 fill-current"></i> Ràtua x<span id="streakCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Graella Opcions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="optionsGrid">
                    <!-- Es generen via JS -->
                </div>
                
                <!-- Missatge Feedback -->
                <div id="feedbackMsg" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white px-8 py-6 rounded-2xl shadow-2xl text-center z-50 min-w-[200px]">
                    <div id="feedbackIcon" class="mx-auto mb-2"></div>
                    <h3 id="feedbackText" class="text-2xl font-bold">Correcte!</h3>
                    <p id="pointsEarned" class="text-green-600 font-bold text-lg">+150 pts</p>
                </div>

            </div>

            <!-- PANTALLA FINAL -->
            <div id="endScreen" class="hidden glass-panel rounded-3xl p-8 text-center shadow-2xl">
                <div class="mb-6">
                    <i data-lucide="trophy" class="w-20 h-20 mx-auto text-yellow-500 fill-current animate-bounce"></i>
                </div>
                <h2 class="text-4xl font-bold text-slate-800 mb-2">Quiz Completat!</h2>
                <p class="text-slate-500 mb-6" id="endMessage">Has respost a totes les comarques.</p>
                
                <div class="bg-green-50 rounded-2xl p-6 mb-8 max-w-sm mx-auto">
                    <div class="text-sm text-slate-500 font-bold uppercase mb-1">Puntuació Final</div>
                    <div class="text-5xl font-black text-green-600" id="finalScore">0</div>
                    <div class="text-slate-400 text-sm mt-2">de <span id="maxScore">0</span> possibles</div>
                </div>

                <div class="flex gap-4">
                    <button onclick="goToHome()" class="flex-1 py-4 bg-white border-2 border-green-100 text-green-600 font-bold rounded-xl hover:bg-green-50 transition-colors">
                        Inici
                    </button>
                    <button onclick="startQuiz()" class="flex-1 py-4 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition-colors">
                        Tornar a jugar
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. BASE DE DADES COMPLETA (43 Comarques + Províncies)
        const db = [
            { c: "Alt Camp", k: "Valls", p: "Tarragona" },
            { c: "Alt Empordà", k: "Figueres", p: "Girona" },
            { c: "Alt Penedès", k: "Vilafranca del Penedès", p: "Barcelona" },
            { c: "Alt Urgell", k: "La Seu d'Urgell", p: "Lleida" },
            { c: "Alta Ribagorça", k: "El Pont de Suert", p: "Lleida" },
            { c: "Anoia", k: "Igualada", p: "Barcelona" },
            { c: "Aran", k: "Vielha e Mijaran", p: "Lleida" },
            { c: "Bages", k: "Manresa", p: "Barcelona" },
            { c: "Baix Camp", k: "Reus", p: "Tarragona" },
            { c: "Baix Ebre", k: "Tortosa", p: "Tarragona" },
            { c: "Baix Empordà", k: "La Bisbal d'Empordà", p: "Girona" },
            { c: "Baix Llobregat", k: "Sant Feliu de Llobregat", p: "Barcelona" },
            { c: "Baix Penedès", k: "El Vendrell", p: "Tarragona" },
            { c: "Barcelonès", k: "Barcelona", p: "Barcelona" },
            { c: "Berguedà", k: "Berga", p: "Barcelona" },
            { c: "Cerdanya", k: "Puigcerdà", p: "Girona" }, 
            { c: "Conca de Barberà", k: "Montblanc", p: "Tarragona" },
            { c: "Garraf", k: "Vilanova i la Geltrú", p: "Barcelona" },
            { c: "Garrigues", k: "Les Borges Blanques", p: "Lleida" },
            { c: "Garrotxa", k: "Olot", p: "Girona" },
            { c: "Gironès", k: "Girona", p: "Girona" },
            { c: "Lluçanès", k: "Prats de Lluçanès", p: "Barcelona" }, 
            { c: "Maresme", k: "Mataró", p: "Barcelona" },
            { c: "Moianès", k: "Moià", p: "Barcelona" },
            { c: "Montsià", k: "Amposta", p: "Tarragona" },
            { c: "Noguera", k: "Balaguer", p: "Lleida" },
            { c: "Osona", k: "Vic", p: "Barcelona" },
            { c: "Pallars Jussà", k: "Tremp", p: "Lleida" },
            { c: "Pallars Sobirà", k: "Sort", p: "Lleida" },
            { c: "Pla d'Urgell", k: "Mollerussa", p: "Lleida" },
            { c: "Pla de l'Estany", k: "Banyoles", p: "Girona" },
            { c: "Priorat", k: "Falset", p: "Tarragona" },
            { c: "Ribera d'Ebre", k: "Móra d'Ebre", p: "Tarragona" },
            { c: "Ripollès", k: "Ripoll", p: "Girona" },
            { c: "Segarra", k: "Cervera", p: "Lleida" },
            { c: "Segrià", k: "Lleida", p: "Lleida" },
            { c: "Selva", k: "Santa Coloma de Farners", p: "Girona" },
            { c: "Solsonès", k: "Solsona", p: "Lleida" },
            { c: "Tarragonès", k: "Tarragona", p: "Tarragona" },
            { c: "Terra Alta", k: "Gandesa", p: "Tarragona" },
            { c: "Urgell", k: "Tàrrega", p: "Lleida" },
            { c: "Vallès Occidental", k: "Sabadell i Terrassa", p: "Barcelona" },
            { c: "Vallès Oriental", k: "Granollers", p: "Barcelona" }
        ];

        // 2. CONFIGURACIÓ I ESTAT
        let config = { zone: ['all'], amount: 'all' };
        let gameState = { queue: [], currentIdx: 0, score: 0, streak: 0, canClick: false, timer: null, startTime: 0 };
        const TIME_PER_QUESTION = 10000; 

        function toggleZone(zone) {
            if (zone === 'all') config.zone = ['all'];
            else {
                if (config.zone.includes('all')) config.zone = [];
                if (config.zone.includes(zone)) config.zone = config.zone.filter(z => z !== zone);
                else config.zone.push(zone);
                if (config.zone.length === 0) config.zone = ['all'];
            }
            updateZoneButtonsUI();
        }

        function updateZoneButtonsUI() {
            const buttons = document.querySelectorAll('#zoneSelector .config-btn');
            buttons.forEach(btn => {
                const zoneVal = btn.getAttribute('data-zone');
                if (config.zone.includes(zoneVal)) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }

        function selectAmount(btn, amount) {
            config.amount = amount;
            document.querySelectorAll('#amountSelector .config-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function goToHome() {
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            gameState.score = 0;
            gameState.streak = 0;
            updateScoreUI();
        }

        function startQuiz() {
            let filteredDb = [...db];
            if (!config.zone.includes('all')) filteredDb = db.filter(item => config.zone.includes(item.p));
            filteredDb.sort(() => Math.random() - 0.5);

            let limit = filteredDb.length;
            if (config.amount !== 'all') limit = Math.min(parseInt(config.amount), filteredDb.length);
            
            gameState.queue = filteredDb.slice(0, limit);
            gameState.score = 0;
            gameState.currentIdx = 0;
            gameState.streak = 0;
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            let badgeText = "CAT";
            if (config.zone.includes('all')) badgeText = "CAT";
            else if (config.zone.length === 1) {
                const map = { 'Barcelona': 'BCN', 'Girona': 'GIR', 'Lleida': 'LLE', 'Tarragona': 'TGN' };
                badgeText = map[config.zone[0]] || config.zone[0];
            } else badgeText = "MIX";
            document.getElementById('zoneBadge').innerText = badgeText;

            updateScoreUI();
            nextQuestion();
        }

        function nextQuestion() {
            if (gameState.currentIdx >= gameState.queue.length) { endGame(); return; }

            const currentData = gameState.queue[gameState.currentIdx];
            document.getElementById('questionText').innerText = currentData.c;
            document.getElementById('questionCounter').innerText = `${gameState.currentIdx + 1} / ${gameState.queue.length}`;
            
            const streakBadge = document.getElementById('streakBadge');
            if (gameState.streak > 1) {
                streakBadge.classList.remove('hidden');
                document.getElementById('streakCount').innerText = gameState.streak;
            } else streakBadge.classList.add('hidden');

            let options = [currentData.k]; 
            const incorrectPool = db.filter(i => i.k !== currentData.k);
            while (options.length < 4) {
                const randomItem = incorrectPool[Math.floor(Math.random() * incorrectPool.length)];
                if (!options.includes(randomItem.k)) options.push(randomItem.k);
            }
            options.sort(() => Math.random() - 0.5);

            const colors = [
                { bg: 'bg-red-500', border: 'border-red-700' },
                { bg: 'bg-blue-500', border: 'border-blue-700' },
                { bg: 'bg-yellow-500', border: 'border-yellow-700' },
                { bg: 'bg-green-500', border: 'border-green-700' }
            ];

            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const style = colors[idx];
                btn.className = `quiz-btn ${style.bg} text-white p-6 rounded-2xl font-bold text-lg md:text-xl shadow-lg border-b-4 ${style.border} w-full h-full`;
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt, currentData.k, btn);
                grid.appendChild(btn);
            });

            const timerBar = document.getElementById('timerBar');
            timerBar.classList.remove('active');
            void timerBar.offsetWidth; 
            timerBar.classList.add('active'); 

            gameState.canClick = true;
            gameState.startTime = Date.now();
            clearTimeout(gameState.timer);
            gameState.timer = setTimeout(() => { handleAnswer(null, currentData.k, null); }, TIME_PER_QUESTION);
        }

        function handleAnswer(selected, correct, btnElement) {
            if (!gameState.canClick) return;
            gameState.canClick = false;
            clearTimeout(gameState.timer);
            document.getElementById('timerBar').classList.remove('active');

            const isCorrect = selected === correct;
            let points = 0;

            const allBtns = document.getElementById('optionsGrid').children;
            for (let btn of allBtns) {
                if (btn.innerText === correct) btn.classList.add('correct-anim'); 
                else if (btn === btnElement && !isCorrect) btn.classList.add('wrong-anim'); 
                else btn.style.opacity = '0.5'; 
            }

            if (isCorrect) {
                const timeTaken = Date.now() - gameState.startTime;
                const timeBonus = Math.max(0, Math.floor((1 - timeTaken/TIME_PER_QUESTION) * 500));
                points = 1000 + timeBonus;
                gameState.score += points;
                gameState.streak++;
                showFeedback(true, points);
                if (gameState.streak > 2) confetti({ particleCount: 50, spread: 50, origin: { y: 0.7 } });
            } else {
                gameState.streak = 0; 
                showFeedback(false, 0);
            }
            
            updateScoreUI();
            setTimeout(() => { hideFeedback(); gameState.currentIdx++; nextQuestion(); }, 2000); 
        }

        function showFeedback(isCorrect, points) {
            const msg = document.getElementById('feedbackMsg');
            const icon = document.getElementById('feedbackIcon');
            const text = document.getElementById('feedbackText');
            const pts = document.getElementById('pointsEarned');
            
            msg.classList.remove('hidden');
            if (isCorrect) {
                icon.innerHTML = '<i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto"></i>';
                text.innerText = "Correcte!";
                text.className = "text-2xl font-bold text-green-600";
                pts.innerText = `+${points} pts`;
            } else {
                icon.innerHTML = '<i data-lucide="x-circle" class="w-16 h-16 text-red-500 mx-auto"></i>';
                text.innerText = "Llàstima!";
                text.className = "text-2xl font-bold text-red-600";
                pts.innerText = "+0 pts";
            }
            lucide.createIcons();
        }

        function hideFeedback() { document.getElementById('feedbackMsg').classList.add('hidden'); }
        function updateScoreUI() { document.getElementById('scoreDisplay').innerText = gameState.score; }

        function endGame() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('endMessage').innerText = `Has completat les ${gameState.queue.length} preguntes seleccionades.`;
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
            const maxPoints = gameState.queue.length * 1500;
            animateValue("finalScore", 0, gameState.score, 1500);
            document.getElementById('maxScore').innerText = maxPoints;
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>
