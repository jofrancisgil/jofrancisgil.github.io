import React, { useState, useEffect } from 'react';
import { RefreshCw, CheckCircle, Trash2, Trophy } from 'lucide-react';

const BingoApp = () => {
  const [ticket, setTicket] = useState([]);
  const [loading, setLoading] = useState(false);

  // Configuració de les columnes segons la petició
  // Columna 0: 1-10, Columna 1: 11-20, ..., Columna 8: 81-90
  const generateRanges = () => {
    const ranges = [];
    for (let i = 0; i < 9; i++) {
      ranges.push({
        min: i * 10 + 1,
        max: (i + 1) * 10
      });
    }
    return ranges;
  };

  const generateTicket = () => {
    setLoading(true);
    
    // Intentem generar una distribució vàlida (a vegades l'aleatorietat pot deixar una columna buida, així que iterem fins que sigui perfecte)
    let layoutIsValid = false;
    let gridLayout = [];

    while (!layoutIsValid) {
      // 1. Inicialitzar graella buida de 3 files x 9 columnes
      gridLayout = [
        Array(9).fill(null),
        Array(9).fill(null),
        Array(9).fill(null)
      ];

      // 2. Assignar 5 posicions actives per fila (aleatòriament)
      for (let r = 0; r < 3; r++) {
        const availableCols = [0, 1, 2, 3, 4, 5, 6, 7, 8];
        // Barrejar columnes
        const shuffledCols = availableCols.sort(() => 0.5 - Math.random());
        // Agafar les primeres 5
        const selectedCols = shuffledCols.slice(0, 5);
        
        selectedCols.forEach(colIndex => {
          gridLayout[r][colIndex] = { value: 0, marked: false, placeholder: false };
        });
      }

      // 3. Validar regles de Bingo
      // - Cap columna pot estar totalment buida (opcional però recomanable per estètica)
      // - Màxim 3 números per columna (lògicament impossible superar-ho amb 3 files, però bé saber-ho)
      const colCounts = Array(9).fill(0);
      for (let c = 0; c < 9; c++) {
        for (let r = 0; r < 3; r++) {
          if (gridLayout[r][c] !== null) colCounts[c]++;
        }
      }

      // Si totes les columnes tenen almenys 1 número, és vàlid
      if (colCounts.every(count => count > 0)) {
        layoutIsValid = true;
      }
    }

    // 4. Omplir amb números reals ordenats per columna
    const ranges = generateRanges();
    
    for (let c = 0; c < 9; c++) {
      // Identificar quines files tenen forat en aquesta columna
      const activeRows = [];
      for (let r = 0; r < 3; r++) {
        if (gridLayout[r][c] !== null) activeRows.push(r);
      }

      // Generar 'n' números aleatoris únics per aquesta columna dins del seu rang
      const countNeeded = activeRows.length;
      const range = ranges[c];
      const numbers = new Set();
      
      while (numbers.size < countNeeded) {
        const num = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
        numbers.add(num);
      }

      // Ordenar els números de menor a major (verticalment)
      const sortedNumbers = Array.from(numbers).sort((a, b) => a - b);

      // Assignar-los a la graella
      activeRows.forEach((rowIndex, i) => {
        gridLayout[rowIndex][c].value = sortedNumbers[i];
      });
    }

    // Marcar les cel·les buides explícitament per pintar-les
    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 9; c++) {
        if (gridLayout[r][c] === null) {
          gridLayout[r][c] = { value: null, marked: false, placeholder: true };
        }
      }
    }

    setTicket(gridLayout);
    setLoading(false);
  };

  const toggleNumber = (rowIndex, colIndex) => {
    const cell = ticket[rowIndex][colIndex];
    if (cell.placeholder) return;

    const newTicket = [...ticket];
    newTicket[rowIndex][colIndex] = {
      ...cell,
      marked: !cell.marked
    };
    setTicket(newTicket);
  };

  // Comprovació de l'estat "BINGO"
  // Només és bingo si hi ha tiquets i TOTS els números (que no siguin placeholder) estan marcats
  const isBingo = ticket.length > 0 && ticket.every(row => 
    row.every(cell => cell.placeholder || cell.marked)
  );

  useEffect(() => {
    generateTicket();
  }, []);

  return (
    <div className="min-h-screen bg-slate-100 flex flex-col items-center py-10 px-4 font-sans relative overflow-hidden">
      
      {/* Animació i Overlay de BINGO */}
      {isBingo && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-300">
           <div className="bg-white p-12 rounded-3xl shadow-2xl flex flex-col items-center text-center border-8 border-yellow-400 animate-[bounce_1s_infinite]">
              <Trophy className="w-24 h-24 text-yellow-500 mb-4 animate-pulse" />
              <h2 className="text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 mb-2 drop-shadow-md tracking-wider">
                BINGO!
              </h2>
              <p className="text-2xl text-slate-700 font-bold mb-8">Enhorabona! Has completat la butlleta.</p>
              
              <button 
                onClick={generateTicket}
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-full text-xl font-bold transition-all shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 flex items-center gap-2"
              >
                <RefreshCw className="w-6 h-6" />
                Nova Partida
              </button>
           </div>
           
           {/* Efecte confeti CSS senzill (cercles de fons) */}
           <div className="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-[-1]">
             <div className="absolute top-1/4 left-1/4 w-4 h-4 bg-red-500 rounded-full animate-ping"></div>
             <div className="absolute top-1/3 right-1/4 w-6 h-6 bg-yellow-400 rounded-full animate-ping delay-75"></div>
             <div className="absolute bottom-1/4 left-1/3 w-5 h-5 bg-blue-500 rounded-full animate-ping delay-150"></div>
             <div className="absolute top-1/2 left-1/2 w-8 h-8 bg-green-500 rounded-full animate-ping delay-300"></div>
           </div>
        </div>
      )}

      <header className="mb-8 text-center">
        <h1 className="text-4xl font-bold text-slate-800 mb-2">Bingo Català 90</h1>
        <p className="text-slate-600">Generador automàtic de butlletes</p>
      </header>

      {/* Contenidor de la butlleta */}
      <div className="bg-white p-2 rounded-xl shadow-2xl border-4 border-slate-800 max-w-full overflow-x-auto z-10">
        <div className="flex flex-col gap-1 min-w-[800px]">
          {ticket.map((row, rowIndex) => (
            <div key={rowIndex} className="flex gap-1 h-24">
              {row.map((cell, colIndex) => {
                // Estil per cel·les buides (tapades)
                if (cell.placeholder) {
                  return (
                    <div 
                      key={`${rowIndex}-${colIndex}`}
                      className="flex-1 bg-indigo-500 rounded-md relative overflow-hidden shadow-inner"
                      title="Espai tapat"
                    >
                       <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle,_rgba(255,255,255,0.4)_2px,_transparent_3px)] bg-[length:10px_10px]"></div>
                    </div>
                  );
                }

                // Estil per cel·les amb número
                return (
                  <div 
                    key={`${rowIndex}-${colIndex}`}
                    onClick={() => toggleNumber(rowIndex, colIndex)}
                    className={`
                      flex-1 rounded-md border-2 flex items-center justify-center text-4xl font-bold cursor-pointer transition-all duration-200 select-none shadow-sm
                      ${cell.marked 
                        ? 'bg-amber-100 border-amber-500 text-slate-800 relative' 
                        : 'bg-white border-slate-200 text-slate-900 hover:bg-slate-50 hover:border-indigo-300'
                      }
                    `}
                  >
                    {cell.value}
                    
                    {/* Marca visual quan està seleccionat */}
                    {cell.marked && (
                      <div className="absolute inset-0 flex items-center justify-center opacity-60">
                         <div className="w-16 h-16 rounded-full border-4 border-red-600 bg-red-200/50"></div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      </div>

      {/* Controls */}
      <div className="mt-10 flex gap-4 z-10">
        <button 
          onClick={generateTicket}
          className="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all"
        >
          <RefreshCw className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
          Generar Nova Butlleta
        </button>
      </div>

      <div className="mt-12 max-w-2xl text-slate-500 text-sm text-center">
        <p>Regles aplicades: 9 columnes x 3 files. 5 números per fila. Rangs de 10 en 10 (1-10, 11-20, etc.). Ordenats verticalment.</p>
      </div>
    </div>
  );
};

export default BingoApp;
